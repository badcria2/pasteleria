<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pasteler√≠a C√≥rdova - Tradici√≥n y Calidad</title>
    <link rel="stylesheet" th:href="@{/css/estilos.css}">
    <link rel="shortcut icon" th:href="@{/imagenes/Logo.jpg}" type="image/x-icon">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body>
<!-- Header -->
<header>
    <nav>
        <div class="logo">Pasteler√≠a C√≥rdova</div>
        <div class="search-bar">
            <form th:action="@{/}" method="get">
                <input type="text" name="buscar" th:value="${param.buscar}"
                       placeholder="Buscar productos..." id="searchInput">
                <button type="submit">üîç</button>
            </form>
        </div>
        <ul class="nav-links">
            <li><a href="#inicio">Inicio</a></li>
            <li><a href="#productos">Productos</a></li>
            <li><a href="#contacto">Contacto</a></li>
            <li><a href="#opiniones">Opiniones</a></li>

            <!-- L√≥gica para mostrar Iniciar Sesi√≥n / Nombre de Usuario + Carrito + Cerrar Sesi√≥n -->
            <li sec:authorize="!isAuthenticated()">
                <a th:href="@{/login}">Iniciar Sesi√≥n</a>
            </li>
            <li sec:authorize="isAuthenticated() and hasRole('CLIENTE')">
                <a th:href="@{/pedidos/mis-compras}">Mis Compras</a>
            </li>
            <li sec:authorize="isAuthenticated()">
                <!-- Icono o enlace al carrito. Podr√≠as a√±adir un contador de √≠tems aqu√≠ -->
                <a th:href="@{/carrito}" class="cart-icon-link">
                    üõí <span id="cart-count" class="cart-count">0</span>
                </a>
            </li>
            <li sec:authorize="isAuthenticated()">
                <a href="#">Hola, <span sec:authentication="name">Usuario</span>!</a>
            </li>
            <li sec:authorize="isAuthenticated()">
                <form th:action="@{/logout}" method="post" style="display:inline;">
                    <button type="submit" class="nav-logout-btn">Cerrar Sesi√≥n</button>
                </form>
            </li>
        </ul>
    </nav>
</header>

<!-- Hero Section -->
<section id="inicio" class="hero">
    <h1>Bienvenidos a Pasteler√≠a C√≥rdova</h1>
    <p>Tradici√≥n, calidad y sabor en cada bocado</p>
    <button class="btn" onclick="location.href='#productos'">Ver Productos</button>
</section>

<!-- Productos Section -->
<section id="productos" class="productos">
    <h2>Nuestros Productos</h2>

    <!-- Filtros -->
    <div class="filter-section" style="text-align: center; margin-bottom: 2rem;">

        <!-- TODOS -->
        <a th:href="@{/}"
           class="filter-btn"
           th:classappend="${categoria == null ? ' active' : ''}">
            Todos
        </a>

        <!-- TORTAS -->
        <a th:href="@{/(categoria='Tortas')}"
           class="filter-btn"
           th:classappend="${categoria == 'Tortas' ? ' active' : ''}">
            Tortas
        </a>

        <!-- CUPCAKES -->
        <a th:href="@{/(categoria='Croissants')}"
           class="filter-btn"
           th:classappend="${categoria == 'Croissants' ? ' active' : ''}">
            Croissants
        </a>

        <!-- POSTRES -->
        <a th:href="@{/(categoria='Postres')}"
           class="filter-btn"
           th:classappend="${categoria == 'Postres' ? ' active' : ''}">
            Postres
        </a>

        <!-- PIES -->
        <a th:href="@{/(categoria='Queques')}"
           class="filter-btn"
           th:classappend="${categoria == 'Queques' ? ' active' : ''}">
            Queques
        </a>

    </div>

    <div class="productos-grid" id="productosGrid" th:if="${productos != null && !productos.isEmpty()}">
        <!-- Producto generado din√°micamente desde BD -->
        <div class="producto-card" th:each="producto : ${productos}" th:attr="data-nombre=${producto.nombre}">
            <div class="producto-img-container">
                <img th:src="${producto.imagen != null ? '/uploads/productos/' + producto.imagen : '/Imagenes/default.jpg'}"
                     th:alt="${producto.nombre}"
                     onerror="this.src='/Imagenes/default.jpg'" />
            </div>
            <div class="producto-info">
                <h3 th:text="${producto.nombre}">Nombre del Producto</h3>
                <p th:text="${producto.descripcion}">Descripci√≥n del producto</p>
                <div class="precio">
                    S/ <span th:text="${#numbers.formatDecimal(producto.precio, 1, 2)}">0.00</span>
                </div>
                <button class="btn btn-carrito"
                        th:attr="data-nombre=${producto.nombre},
                 data-precio=${producto.precio},
                 data-id=${producto.id}"
                        onclick="agregarDesdeBoton(this)">
                    Agregar al Carrito
                </button>

            </div>
        </div>
    </div>

    <!-- Si no hay productos -->
    <div th:if="${productos == null || productos.isEmpty()}" style="text-align: center; padding: 3rem;">
        <h3>No se encontraron productos</h3>
        <p>Intenta con otra b√∫squeda o categor√≠a</p>
    </div>
</section>

<!-- Opiniones Section -->
<section id="opiniones" class="opiniones">
    <h2>Opiniones de Nuestros Clientes</h2>

    <div class="opiniones-grid" th:if="${resenas != null && !resenas.isEmpty()}">

        <div class="opinion-card" th:each="resena : ${resenas}">
            <!-- Mostrar estrellas seg√∫n calificaci√≥n -->
            <div class="estrellas"
                 th:text="${'‚≠ê'.repeat(resena.calificacion)}">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>

            <!-- Comentario -->
            <p th:text="${resena.comentario}">Comentario del cliente</p>

            <!-- Nombre del cliente -->
            <div class="opinion-autor">
                <span th:text="'- ' + ${resena.cliente.usuario.nombre}"></span>
            </div>

            <!-- Fecha (opcional) -->
            <div style="font-size: 0.8rem; color: #777;"
                 th:text="${#temporals.format(resena.fechaCreacion, 'dd/MM/yyyy')}">
            </div>
        </div>
    </div>

    <!-- Si no hay rese√±as -->
    <div th:if="${resenas == null || resenas.isEmpty()}">
        <p style="text-align:center; color: #555;">A√∫n no hay rese√±as disponibles</p>
    </div>
</section>

<!-- Contacto Section -->
<section id="contacto" class="contacto">
    <h2>Cont√°ctanos</h2>
    <div class="contacto-content">
        <div class="contacto-info">
            <h3 style="color: #8B4513; margin-bottom: 1rem;">Informaci√≥n de Contacto</h3>
            <div class="info-item">
                <span>üìç</span>
                <div>
                    <strong>Sedes: </strong><br>
                    Jir√≥n Las Magnolias 501, Lima 15812 /
                    Av. Jos√© Carlos Mari√°tegui 1780, VMT 15803 /
                    Av. Jos√© Carlos Mari√°tegui 1090, VMT 15811 /
                    Av. San Juan 609-B, San Juan de Miraflores
                </div>
            </div>
            <div class="info-item">
                <span>üìû</span>
                <div>
                    <strong>Tel√©fono:</strong><br>
                    +51 919714277
                </div>
            </div>
            <div class="info-item">
                <span>üìß</span>
                <div>
                    <strong>Email:</strong><br>
                    pasteleriacordova@gmail.com
                </div>
            </div>
            <div class="info-item">
                <span>üí¨</span>
                <div>
                    <strong>WhatsApp:</strong><br>
                    <a href="https://wa.me/51919714277" style="color: #25d366; text-decoration: none;">Enviar mensaje</a>
                </div>
            </div>
        </div>

        <div class="contacto-form">
            <h3 style="color: #8B4513; margin-bottom: 1rem;">Env√≠anos un Mensaje</h3>
            <input type="text" placeholder="Nombre" required>
            <input type="email" placeholder="Email" required>
            <input type="tel" placeholder="Tel√©fono" required>
            <textarea rows="5" placeholder="Mensaje" required></textarea>
            <button class="btn" style="width: 100%;">Enviar Mensaje</button>
        </div>
    </div>
</section>

<!-- Footer -->
<footer>
    <p>&copy; 2025 Pasteler√≠a C√≥rdova. Todos los derechos reservados.</p>
    <p>4 locales en Lima | Tradici√≥n y Calidad desde siempre</p>
</footer>

<!-- Bot√≥n flotante de WhatsApp -->
<a href="https://wa.me/51919714277?text=Pasteler√≠a%20C√≥rdova%2C%20me%20gustar√≠a%20realizar%20un%20pedido%20personalizado"
   class="whatsapp-float"
   target="_blank"
   title="Contactar por WhatsApp">
    <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp" width="60" height="60">
</a>

<!-- Script para inyectar variables de seguridad de Thymeleaf en el scope global de JS -->
<!-- Cerca del final del body, ANTES de cargar main.js -->
<script th:inline="javascript">
    console.log("-----------------------------------------");
    console.log("Debugging Thymeleaf Security Expressions");

    // SOLUCI√ìN APROPIADA para thymeleaf-extras-springsecurity5:
    // Usa #authentication.principal.authorities para roles
    // Usa #authentication.isAuthenticated() si tu versi√≥n de Spring Security lo soporta en #authentication
    // Lo m√°s seguro para hasRole es usar el .expression() o verificar roles en el principal

    // 1. Acceder al nombre del usuario directamente (funciona si hay un principal)
    var authName = /*[[${#authentication?.name}]]*/ 'N/A';
    console.log("#authentication?.name:", authName);

    // 2. Para saber si est√° autenticado: USAR #authentication.isAuthenticated()
    // Esto es lo m√°s directo y compatible.
    var directIsAuthenticated = /*[[${#authentication.isAuthenticated()}]]*/ false;
    console.log("#authentication.isAuthenticated() (recommended):", directIsAuthenticated);

    // 3. Para verificar roles: USAR #authorization.expression() con la expresi√≥n SPEL
    // Esta es la forma correcta para roles cuando el m√©todo directo no funciona en #authorization
    var directIsClient = /*[[${#authorization.expression('hasRole("CLIENTE")')}]]*/ false;
    console.log("#authorization.expression('hasRole(\"CLIENTE\")') (recommended for roles):", directIsClient);


    // (Opcional) Tu c√≥digo original con .expression(), que deber√≠a funcionar ahora para isAuthenticated
    // ya que hasRole ya lo estabas usando.
    // window.isAuthenticated = /*[[${#authorization.expression('isAuthenticated()')}]]*/ false; // Esto tambi√©n deber√≠a funcionar ahora
    // window.isClient = /*[[${#authorization.expression('hasRole("CLIENTE")')}]]*/ false; // Esto ya deber√≠a funcionar


    // A partir de los resultados de arriba, puedes asignar a tus variables globales:
    window.isAuthenticated = directIsAuthenticated; // O #authorization.expression('isAuthenticated()')
    window.isClient = directIsClient;

    console.log("Final window.isAuthenticated:", window.isAuthenticated);
    console.log("Final window.isClient:", window.isClient);

    console.log("-----------------------------------------");
</script>

<!-- Cargar tu archivo JavaScript externo -->
<script th:src="@{/js/main.js}"></script>
</body>
</html>