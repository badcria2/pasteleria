<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pasteler√≠a C√≥rdova - Tradici√≥n y Calidad</title>
    <link rel="stylesheet" th:href="@{/css/estilos.css}">
    <link rel="shortcut icon" th:href="@{/imagenes/Logo.jpg}" type="image/x-icon">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body>
<!-- Header -->
<header>
    <nav>
        <div class="logo">Pasteler√≠a C√≥rdova</div>
        <div class="search-bar">
            <form th:action="@{/}" method="get">
                <input type="text" name="buscar" th:value="${param.buscar}"
                       placeholder="Buscar productos..." id="searchInput">
                <button type="submit">üîç</button>
            </form>
        </div>
        <ul class="nav-links">
            <li><a th:href="@{/}">Inicio</a></li>
            <li><a href="#productos">Productos</a></li>
            <li><a th:href="@{/contacto}">Contacto</a></li>
            <li><a href="#opiniones">Opiniones</a></li>

            <!-- L√≥gica para mostrar Iniciar Sesi√≥n / Nombre de Usuario + Carrito + Cerrar Sesi√≥n -->
            <li sec:authorize="!isAuthenticated()">
                <a th:href="@{/login}">Iniciar Sesi√≥n</a>
            </li>
            <li sec:authorize="!isAuthenticated()">
                <a th:href="@{/registro}">Registrarse</a>
            </li>
            <li sec:authorize="isAuthenticated() and hasRole('CLIENTE')">
                <a th:href="@{/pedidos/mis-compras}">Mis Compras</a>
            </li>
            <li sec:authorize="isAuthenticated()">
                <!-- Icono o enlace al carrito. Podr√≠as a√±adir un contador de √≠tems aqu√≠ -->
                <a th:href="@{/carrito}" class="cart-icon-link">
                    üõí <span id="cart-count" class="cart-count">0</span>
                </a>
            </li>
            <li sec:authorize="isAuthenticated()">
                <a href="#">Hola, <span sec:authentication="name">Usuario</span>!</a>
            </li>
            <li sec:authorize="isAuthenticated()">
                <form th:action="@{/logout}" method="post" style="display:inline;">
                    <button type="submit" class="nav-logout-btn">Cerrar Sesi√≥n</button>
                </form>
            </li>
        </ul>
    </nav>
</header>

<!-- Hero Section -->
<section id="inicio" class="hero">
    <h1>Bienvenidos a Pasteler√≠a C√≥rdova</h1>
    <p>Tradici√≥n, calidad y sabor en cada bocado</p>
    <button class="btn" onclick="location.href='#productos'">Ver Productos</button>
</section>

<!-- Productos Section -->
<section id="productos" class="productos">
    <h2>Nuestros Productos</h2>

    <!-- Filtros -->
    <div class="filter-section" style="text-align: center; margin-bottom: 2rem;">

        <!-- TODOS -->
        <a th:href="@{/}"
           class="filter-btn"
           th:classappend="${categoria == null ? ' active' : ''}">
            Todos
        </a>

        <!-- TORTAS -->
        <a th:href="@{/(categoria='Tortas')}"
           class="filter-btn"
           th:classappend="${categoria == 'Tortas' ? ' active' : ''}">
            Tortas
        </a>

        <!-- CUPCAKES -->
        <a th:href="@{/(categoria='Croissants')}"
           class="filter-btn"
           th:classappend="${categoria == 'Croissants' ? ' active' : ''}">
            Croissants
        </a>

        <!-- POSTRES -->
        <a th:href="@{/(categoria='Postres')}"
           class="filter-btn"
           th:classappend="${categoria == 'Postres' ? ' active' : ''}">
            Postres
        </a>

        <!-- PIES -->
        <a th:href="@{/(categoria='Queques')}"
           class="filter-btn"
           th:classappend="${categoria == 'Queques' ? ' active' : ''}">
            Queques
        </a>

    </div>

    <div class="productos-grid" id="productosGrid" th:if="${productos != null && !productos.isEmpty()}">
        <!-- Producto generado din√°micamente desde BD -->
        <div class="producto-card" th:each="producto : ${productos}" th:attr="data-nombre=${producto.nombre}">
            <div class="producto-img-container">
                <img th:src="${producto.imagen != null ? producto.imagen : '/Imagenes/default.jpg'}"
                     th:alt="${producto.nombre}"
                     onerror="this.src='/Imagenes/default.jpg'" />
            </div>
            <div class="producto-info">
                <h3 th:text="${producto.nombre}">Nombre del Producto</h3>
                <p th:text="${producto.descripcion}">Descripci√≥n del producto</p>
                <div class="precio">
                    S/ <span th:text="${#numbers.formatDecimal(producto.precio, 1, 2)}">0.00</span>
                </div>
                <button class="btn btn-carrito"
                        th:attr="data-nombre=${producto.nombre},
                 data-precio=${producto.precio},
                 data-id=${producto.id}"
                        onclick="agregarDesdeBoton(this)">
                    Agregar al Carrito
                </button>

            </div>
        </div>
    </div>

    <!-- Si no hay productos -->
    <div th:if="${productos == null || productos.isEmpty()}" style="text-align: center; padding: 3rem;">
        <h3>No se encontraron productos</h3>
        <p>Intenta con otra b√∫squeda o categor√≠a</p>
    </div>
</section>

<!-- Opiniones Section -->
<section id="opiniones" class="opiniones">
    <h2>Opiniones de Nuestros Clientes</h2>

    <div class="opiniones-grid" th:if="${resenas != null && !resenas.isEmpty()}">

        <div class="opinion-card" th:each="resena : ${resenas}">
            <!-- Mostrar estrellas seg√∫n calificaci√≥n -->
            <div class="estrellas"
                 th:text="${'‚≠ê'.repeat(resena.calificacion)}">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>

            <!-- Comentario -->
            <p th:text="${resena.comentario}">Comentario del cliente</p>

            <!-- Nombre del cliente -->
            <div class="opinion-autor">
                <span th:text="'- ' + ${resena.cliente.usuario.nombre}"></span>
            </div>

            <!-- Fecha (opcional) -->
            <div style="font-size: 0.8rem; color: #777;"
                 th:text="${#temporals.format(resena.fechaCreacion, 'dd/MM/yyyy')}">
            </div>
        </div>
    </div>

    <!-- Si no hay rese√±as -->
    <div th:if="${resenas == null || resenas.isEmpty()}">
        <p style="text-align:center; color: #555;">A√∫n no hay rese√±as disponibles</p>
    </div>
</section>

<!-- Contacto Section -->
<section id="contacto" style="background: #FFF5E6; padding: 4rem 2rem;">
    <div style="max-width: 1200px; margin: 0 auto;">
        <div style="text-align: center; margin-bottom: 3rem;">
            <h2 style="color: #8B4513; font-size: 2.2rem; margin-bottom: 1rem;">Cont√°ctanos</h2>
            <div style="width: 80px; height: 4px; background: linear-gradient(90deg, #8B4513, #E8956C); 
                        margin: 0 auto; border-radius: 2px;"></div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem;">
            <!-- Sedes -->
            <div style="background: white; padding: 2.5rem; border-radius: 20px; 
                        box-shadow: 0 10px 30px rgba(0,0,0,0.1); transition: all 0.3s ease; 
                        border-top: 5px solid #8B4513; position: relative; overflow: hidden;"
                 onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 15px 40px rgba(0,0,0,0.15)'"
                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 10px 30px rgba(0,0,0,0.1)'">
                <div style="position: absolute; top: -50%; right: -50%; width: 100px; height: 100px; 
                            background: linear-gradient(45deg, #F5DEB3, transparent); 
                            border-radius: 50%; opacity: 0.1;"></div>
                <div style="display: flex; align-items: center; margin-bottom: 1.5rem; position: relative; z-index: 1;">
                    <div style="background: linear-gradient(135deg, #8B4513, #A0522D); color: white; 
                                padding: 1rem; border-radius: 15px; margin-right: 1rem; font-size: 1.5rem; 
                                box-shadow: 0 4px 15px rgba(139, 69, 19, 0.3);">üìç</div>
                    <h3 style="color: #8B4513; margin: 0; font-size: 1.4rem; font-weight: 600;">Nuestras Sedes</h3>
                </div>
                <div style="margin-bottom: 1rem; position: relative; z-index: 1;">
                    <strong style="color: #6B3410;">Lima Norte:</strong><br>
                    <span style="color: #666;">Jir√≥n Las Magnolias 501, Lima 15812</span>
                </div>
                <div style="margin-bottom: 1rem; position: relative; z-index: 1;">
                    <strong style="color: #6B3410;">Villa Mar√≠a del Triunfo:</strong><br>
                    <span style="color: #666;">Av. Jos√© Carlos Mari√°tegui 1780, VMT 15803</span>
                </div>
                <div style="margin-bottom: 1rem; position: relative; z-index: 1;">
                    <strong style="color: #6B3410;">Villa Mar√≠a del Triunfo 2:</strong><br>
                    <span style="color: #666;">Av. Jos√© Carlos Mari√°tegui 1090, VMT 15811</span>
                </div>
                <div style="position: relative; z-index: 1;">
                    <strong style="color: #6B3410;">San Juan de Miraflores:</strong><br>
                    <span style="color: #666;">Av. San Juan 609-B</span>
                </div>
            </div>

            <!-- Tel√©fono -->
            <div style="background: white; padding: 2.5rem; border-radius: 20px; 
                        box-shadow: 0 10px 30px rgba(0,0,0,0.1); transition: all 0.3s ease; 
                        border-top: 5px solid #E8956C; position: relative; overflow: hidden;"
                 onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 15px 40px rgba(0,0,0,0.15)'"
                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 10px 30px rgba(0,0,0,0.1)'">
                <div style="position: absolute; top: -50%; right: -50%; width: 100px; height: 100px; 
                            background: linear-gradient(45deg, #E8956C, transparent); 
                            border-radius: 50%; opacity: 0.1;"></div>
                <div style="display: flex; align-items: center; margin-bottom: 1.5rem; position: relative; z-index: 1;">
                    <div style="background: linear-gradient(135deg, #E8956C, #F4A582); color: white; 
                                padding: 1rem; border-radius: 15px; margin-right: 1rem; font-size: 1.5rem; 
                                box-shadow: 0 4px 15px rgba(232, 149, 108, 0.3);">üìû</div>
                    <h3 style="color: #8B4513; margin: 0; font-size: 1.4rem; font-weight: 600;">Tel√©fono</h3>
                </div>
                <a href="tel:+51919714277" 
                   style="color: #E8956C; font-size: 1.8rem; font-weight: bold; margin: 0; text-decoration: none; 
                          display: block; margin-bottom: 0.5rem; position: relative; z-index: 1;"
                   onmouseover="this.style.color='#8B4513'"
                   onmouseout="this.style.color='#E8956C'">+51 919714277</a>
                <p style="color: #666; margin: 0; position: relative; z-index: 1;">Ll√°manos para pedidos y consultas</p>
            </div>

            <!-- WhatsApp -->
            <div style="background: white; padding: 2.5rem; border-radius: 20px; 
                        box-shadow: 0 10px 30px rgba(0,0,0,0.1); transition: all 0.3s ease; 
                        border-top: 5px solid #25D366; position: relative; overflow: hidden;"
                 onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 15px 40px rgba(0,0,0,0.15)'"
                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 10px 30px rgba(0,0,0,0.1)'">
                <div style="position: absolute; top: -50%; right: -50%; width: 100px; height: 100px; 
                            background: linear-gradient(45deg, #25D366, transparent); 
                            border-radius: 50%; opacity: 0.1;"></div>
                <div style="display: flex; align-items: center; margin-bottom: 1.5rem; position: relative; z-index: 1;">
                    <div style="background: linear-gradient(135deg, #25D366, #20B358); color: white; 
                                padding: 1rem; border-radius: 15px; margin-right: 1rem; font-size: 1.5rem; 
                                box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);">üí¨</div>
                    <h3 style="color: #8B4513; margin: 0; font-size: 1.4rem; font-weight: 600;">WhatsApp</h3>
                </div>
                <a href="https://wa.me/51919714277?text=Hola,%20me%20interesa%20hacer%20un%20pedido" 
                   target="_blank"
                   style="display: inline-block; background: linear-gradient(135deg, #25D366, #20B358); 
                          color: white; padding: 1rem 2rem; text-decoration: none; border-radius: 25px; 
                          font-weight: bold; box-shadow: 0 6px 20px rgba(37, 211, 102, 0.4); 
                          transition: all 0.3s ease; position: relative; z-index: 1;"
                   onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 8px 25px rgba(37, 211, 102, 0.5)'"
                   onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 6px 20px rgba(37, 211, 102, 0.4)'">
                    üì± Chatea con nosotros
                </a>
                <p style="color: #666; margin: 0.5rem 0 0 0; position: relative; z-index: 1;">Respuesta inmediata garantizada</p>
            </div>
        </div>
    </div>
</section>

<!-- Footer -->
<footer style="background: linear-gradient(45deg, #6B3410, #8B4513); color: white; text-align: center; 
               padding: 3rem 2rem; position: relative; overflow: hidden;">
    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
                background-image: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.05) 30%, rgba(255,255,255,0.05) 70%, transparent 70%); 
                background-size: 20px 20px;"></div>
    <div style="position: relative; z-index: 1;">
        <div style="font-size: 1.5rem; margin-bottom: 1rem;">üç∞ Pasteler√≠a C√≥rdova üç∞</div>
        <p style="margin: 0; opacity: 0.9;">&copy; 2025 Pasteler√≠a C√≥rdova. Todos los derechos reservados.</p>
        <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; opacity: 0.7;">4 locales en Lima | Tradici√≥n, calidad y sabor en cada bocado</p>
    </div>
</footer>

<!-- Bot√≥n flotante de WhatsApp -->
<a href="https://wa.me/51919714277?text=Pasteler√≠a%20C√≥rdova%2C%20me%20gustar√≠a%20realizar%20un%20pedido%20personalizado"
   class="whatsapp-float"
   target="_blank"
   title="Contactar por WhatsApp">
    <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp" width="60" height="60">
</a>

<!-- Script para inyectar variables de seguridad de Thymeleaf en el scope global de JS -->
<!-- Cerca del final del body, ANTES de cargar main.js -->
<script th:inline="javascript">
    console.log("-----------------------------------------");
    console.log("Debugging Thymeleaf Security Expressions");

    // SOLUCI√ìN APROPIADA para thymeleaf-extras-springsecurity5:
    // Usa #authentication.principal.authorities para roles
    // Usa #authentication.isAuthenticated() si tu versi√≥n de Spring Security lo soporta en #authentication
    // Lo m√°s seguro para hasRole es usar el .expression() o verificar roles en el principal

    // 1. Acceder al nombre del usuario directamente (funciona si hay un principal)
    var authName = /*[[${#authentication?.name}]]*/ 'N/A';
    console.log("#authentication?.name:", authName);

    // 2. Para saber si est√° autenticado: USAR #authentication.isAuthenticated()
    // Esto es lo m√°s directo y compatible.
    var directIsAuthenticated = /*[[${#authentication.isAuthenticated()}]]*/ false;
    console.log("#authentication.isAuthenticated() (recommended):", directIsAuthenticated);

    // 3. Para verificar roles: USAR #authorization.expression() con la expresi√≥n SPEL
    // Esta es la forma correcta para roles cuando el m√©todo directo no funciona en #authorization
    var directIsClient = /*[[${#authorization.expression('hasRole("CLIENTE")')}]]*/ false;
    console.log("#authorization.expression('hasRole(\"CLIENTE\")') (recommended for roles):", directIsClient);


    // (Opcional) Tu c√≥digo original con .expression(), que deber√≠a funcionar ahora para isAuthenticated
    // ya que hasRole ya lo estabas usando.
    // window.isAuthenticated = /*[[${#authorization.expression('isAuthenticated()')}]]*/ false; // Esto tambi√©n deber√≠a funcionar ahora
    // window.isClient = /*[[${#authorization.expression('hasRole("CLIENTE")')}]]*/ false; // Esto ya deber√≠a funcionar


    // A partir de los resultados de arriba, puedes asignar a tus variables globales:
    window.isAuthenticated = directIsAuthenticated; // O #authorization.expression('isAuthenticated()')
    window.isClient = directIsClient;

    console.log("Final window.isAuthenticated:", window.isAuthenticated);
    console.log("Final window.isClient:", window.isClient);

    console.log("-----------------------------------------");
</script>

<!-- Cargar tu archivo JavaScript externo -->
<script th:src="@{/js/main.js}"></script>
</body>
</html>