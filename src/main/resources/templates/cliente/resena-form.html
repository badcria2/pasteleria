<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Escribir Rese√±a - Pasteler√≠a C√≥rdova</title>
  <link rel="stylesheet" th:href="@{/css/estilos.css}">
  <link rel="stylesheet" th:href="@{/css/mis_compras.css}">
  <link rel="shortcut icon" th:href="@{/imagenes/Logo.jpg}" type="image/x-icon">
  
  <style>
    .review-form-container {
      max-width: 700px;
      margin: 4rem auto 2rem auto;
      padding: 2rem;
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    }
    
    .review-form-header {
      text-align: center;
      margin-bottom: 2rem;
      border-bottom: 2px solid #8B4513;
      padding-bottom: 1rem;
    }
    
    .review-form-header h2 {
      color: #8B4513;
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    
    .product-info {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .product-info img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #ddd;
    }
    
    .product-details h3 {
      color: #333;
      margin: 0 0 0.5rem 0;
      font-size: 1.3rem;
    }
    
    .product-details p {
      color: #666;
      margin: 0;
    }
    
    .form-group {
      margin-bottom: 1.8rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.8rem;
      color: #333;
      font-weight: bold;
      font-size: 1.1rem;
    }
    
    .star-rating {
      display: flex;
      gap: 0.3rem;
      margin-bottom: 0.5rem;
    }
    
    .star {
      font-size: 2rem;
      color: #ddd;
      cursor: pointer;
      transition: color 0.2s ease;
    }
    
    .star:hover,
    .star.active {
      color: #ffc107;
    }
    
    .rating-text {
      font-size: 0.9rem;
      color: #666;
      margin-left: 0.5rem;
    }
    
    .form-group textarea {
      width: 100%;
      min-height: 120px;
      padding: 1rem;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-family: inherit;
      font-size: 1rem;
      resize: vertical;
      transition: border-color 0.3s ease;
    }
    
    .form-group textarea:focus {
      outline: none;
      border-color: #8B4513;
      box-shadow: 0 0 0 3px rgba(139, 69, 19, 0.1);
    }
    
    .char-counter {
      text-align: right;
      font-size: 0.9rem;
      color: #666;
      margin-top: 0.3rem;
    }
    
    .form-actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 2rem;
    }
    
    .btn {
      padding: 0.8rem 2rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background-color: #8B4513;
      color: white;
    }
    
    .btn-primary:hover {
      background-color: #a0522d;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(139, 69, 19, 0.3);
    }
    
    .btn-secondary {
      background-color: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background-color: #5a6268;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
    }
    
    .error-message, .success-message {
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      text-align: center;
    }
    
    .error-message {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .success-message {
      background-color: #d1edff;
      color: #0c5460;
      border: 1px solid #b8daff;
    }
    
    .required-asterisk {
      color: #dc3545;
    }
    
    @media (max-width: 768px) {
      .review-form-container {
        margin: 2rem 1rem;
        padding: 1.5rem;
      }
      
      .product-info {
        flex-direction: column;
        text-align: center;
      }
      
      .form-actions {
        flex-direction: column;
        align-items: center;
      }
      
      .btn {
        width: 100%;
        max-width: 200px;
      }
    }
  </style>
</head>
<body>
<header>
  <nav>
    <div class="logo">Pasteler√≠a C√≥rdova</div>
    <div class="search-bar">
      <form th:action="@{/}" method="get">
        <input type="text" name="buscar" th:value="${param.buscar}"
               placeholder="Buscar productos..." id="searchInput">
        <button type="submit">üîç</button>
      </form>
    </div>
    <ul class="nav-links">
      <li><a th:href="@{/}">Inicio</a></li>
      <li><a th:href="@{/#productos}">Productos</a></li>
      <li><a th:href="@{/#contacto}">Contacto</a></li>
      <li><a th:href="@{/#opiniones}">Opiniones</a></li>

      <li sec:authorize="!isAuthenticated()">
        <a th:href="@{/login}">Iniciar Sesi√≥n</a>
      </li>
      <li sec:authorize="isAuthenticated() and hasRole('CLIENTE')">
        <a th:href="@{/pedidos/mis-compras}">Mis Compras</a>
      </li>
      <li sec:authorize="isAuthenticated()">
        <a th:href="@{/carrito}" class="cart-icon-link">
          üõí <span id="cart-count" class="cart-count">0</span>
        </a>
      </li>
      <li sec:authorize="isAuthenticated()">
        <a href="#">Hola, <span sec:authentication="name">Usuario</span>!</a>
      </li>
      <li sec:authorize="isAuthenticated()">
        <form th:action="@{/logout}" method="post" style="display:inline;">
          <button type="submit" class="nav-logout-btn">Cerrar Sesi√≥n</button>
        </form>
      </li>
    </ul>
  </nav>
</header>

<main class="review-form-container">
  <div class="review-form-header">
    <h2>Escribir Rese√±a</h2>
    <p>Comparte tu experiencia con este producto</p>
  </div>

  <!-- Mensajes de error/√©xito -->
  <div th:if="${errorMessage}" class="error-message">
    <p th:text="${errorMessage}"></p>
  </div>
  
  <div th:if="${successMessage}" class="success-message">
    <p th:text="${successMessage}"></p>
  </div>

  <!-- Informaci√≥n del producto -->
  <div class="product-info">
    <img th:src="${producto.imagen != null ? producto.imagen : '/imagenes/producto-default.jpg'}" 
         th:alt="${producto.nombre}" 
         onerror="this.src='/imagenes/producto-default.jpg'">
    <div class="product-details">
      <h3 th:text="${producto.nombre}">Nombre del Producto</h3>
      <p><strong>Pedido #</strong><span th:text="${pedido.id}">123</span></p>
      <p><strong>Fecha del pedido:</strong> <span th:text="${#temporals.format(pedido.fecha, 'dd/MM/yyyy')}">01/01/2025</span></p>
    </div>
  </div>

  <!-- Formulario de rese√±a -->
  <form th:action="@{/resenas/crear}" method="post" id="reviewForm">
    <input type="hidden" name="pedidoId" th:value="${pedido.id}">
    <input type="hidden" name="productoId" th:value="${producto.id}">
    
    <!-- Calificaci√≥n con estrellas -->
    <div class="form-group">
      <label for="rating">Calificaci√≥n <span class="required-asterisk">*</span></label>
      <div class="star-rating" id="starRating">
        <span class="star" data-rating="1">‚òÖ</span>
        <span class="star" data-rating="2">‚òÖ</span>
        <span class="star" data-rating="3">‚òÖ</span>
        <span class="star" data-rating="4">‚òÖ</span>
        <span class="star" data-rating="5">‚òÖ</span>
        <span class="rating-text" id="ratingText">Selecciona una calificaci√≥n</span>
      </div>
      <input type="hidden" name="calificacion" id="calificacionInput" required>
    </div>

    <!-- Comentario -->
    <div class="form-group">
      <label for="comentario">Comentario <span class="required-asterisk">*</span></label>
      <textarea name="comentario" 
                id="comentario" 
                placeholder="Escribe tu rese√±a aqu√≠... Comparte tu experiencia con este producto para ayudar a otros clientes." 
                maxlength="500" 
                required></textarea>
      <div class="char-counter">
        <span id="charCount">0</span>/500 caracteres
      </div>
    </div>

    <!-- Botones de acci√≥n -->
    <div class="form-actions">
      <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
        Enviar Rese√±a
      </button>
      <a th:href="@{/pedidos/mis-compras}" class="btn btn-secondary">
        Cancelar
      </a>
    </div>
  </form>
</main>

<footer>
  <p>&copy; 2025 Pasteler√≠a C√≥rdova. Todos los derechos reservados.</p>
</footer>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const stars = document.querySelectorAll('.star');
    const ratingText = document.getElementById('ratingText');
    const calificacionInput = document.getElementById('calificacionInput');
    const comentario = document.getElementById('comentario');
    const charCount = document.getElementById('charCount');
    const submitBtn = document.getElementById('submitBtn');
    const reviewForm = document.getElementById('reviewForm');
    
    let selectedRating = 0;
    
    const ratingTexts = {
        1: 'Muy malo',
        2: 'Malo',
        3: 'Regular',
        4: 'Bueno',
        5: 'Excelente'
    };
    
    // Sistema de calificaci√≥n por estrellas
    stars.forEach(star => {
        star.addEventListener('click', function() {
            selectedRating = parseInt(this.dataset.rating);
            updateStars();
            updateSubmitButton();
        });
        
        star.addEventListener('mouseover', function() {
            const hoverRating = parseInt(this.dataset.rating);
            highlightStars(hoverRating);
        });
    });
    
    document.getElementById('starRating').addEventListener('mouseleave', function() {
        updateStars();
    });
    
    function highlightStars(rating) {
        stars.forEach((star, index) => {
            if (index < rating) {
                star.classList.add('active');
            } else {
                star.classList.remove('active');
            }
        });
        ratingText.textContent = ratingTexts[rating] || 'Selecciona una calificaci√≥n';
    }
    
    function updateStars() {
        highlightStars(selectedRating);
        calificacionInput.value = selectedRating;
        if (selectedRating > 0) {
            ratingText.textContent = ratingTexts[selectedRating];
        }
    }
    
    // Contador de caracteres
    comentario.addEventListener('input', function() {
        const currentLength = this.value.length;
        charCount.textContent = currentLength;
        
        if (currentLength > 500) {
            charCount.style.color = '#dc3545';
        } else if (currentLength > 450) {
            charCount.style.color = '#ffc107';
        } else {
            charCount.style.color = '#666';
        }
        
        updateSubmitButton();
    });
    
    // Validaci√≥n del formulario
    function updateSubmitButton() {
        const hasRating = selectedRating > 0;
        const hasComment = comentario.value.trim().length > 0 && comentario.value.length <= 500;
        
        submitBtn.disabled = !(hasRating && hasComment);
        
        if (hasRating && hasComment) {
            submitBtn.style.opacity = '1';
            submitBtn.style.cursor = 'pointer';
        } else {
            submitBtn.style.opacity = '0.6';
            submitBtn.style.cursor = 'not-allowed';
        }
    }
    
    // Validaci√≥n antes de enviar
    reviewForm.addEventListener('submit', function(e) {
        if (selectedRating === 0) {
            e.preventDefault();
            alert('Por favor, selecciona una calificaci√≥n.');
            return false;
        }
        
        if (comentario.value.trim().length === 0) {
            e.preventDefault();
            alert('Por favor, escribe un comentario.');
            comentario.focus();
            return false;
        }
        
        if (comentario.value.length > 500) {
            e.preventDefault();
            alert('El comentario no puede exceder 500 caracteres.');
            comentario.focus();
            return false;
        }
        
        // Confirmar env√≠o
        if (!confirm('¬øEst√°s seguro de que deseas enviar esta rese√±a?')) {
            e.preventDefault();
            return false;
        }
    });
    
    // Actualizar estado inicial
    updateSubmitButton();
});
</script>

<script th:src="@{/js/main.js}"></script>

</body>
</html>
