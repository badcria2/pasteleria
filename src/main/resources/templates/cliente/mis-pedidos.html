<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mis Compras - Pasteler√≠a C√≥rdova</title>
  <link rel="stylesheet" th:href="@{/css/estilos.css}">
  <link rel="stylesheet" th:href="@{/css/mis_compras.css}"> <!-- Nuevo CSS para esta vista -->
  <link rel="shortcut icon" th:href="@{/imagenes/Logo.jpg}" type="image/x-icon">
</head>
<body>
<header>
  <nav>
    <div class="logo">Pasteler√≠a C√≥rdova</div>
    <div class="search-bar">
      <form th:action="@{/}" method="get">
        <input type="text" name="buscar" th:value="${param.buscar}"
               placeholder="Buscar productos..." id="searchInput">
        <button type="submit">üîç</button>
      </form>
    </div>
    <ul class="nav-links">
      <li><a th:href="@{/}">Inicio</a></li>
      <li><a th:href="@{/#productos}">Productos</a></li>
      <li><a th:href="@{/#contacto}">Contacto</a></li>
      <li><a th:href="@{/#opiniones}">Opiniones</a></li>

      <li sec:authorize="!isAuthenticated()">
        <a th:href="@{/login}">Iniciar Sesi√≥n</a>
      </li>
      <li sec:authorize="isAuthenticated() and hasRole('CLIENTE')">
        <a th:href="@{/pedidos/mis-compras}">Mis Compras</a>
      </li>
      <li sec:authorize="isAuthenticated()">
        <a th:href="@{/carrito}" class="cart-icon-link">
          üõí <span id="cart-count" class="cart-count">0</span>
        </a>
      </li>
      <li sec:authorize="isAuthenticated()">
        <a href="#">Hola, <span sec:authentication="name">Usuario</span>!</a>
      </li>
      <li sec:authorize="isAuthenticated()">
        <form th:action="@{/logout}" method="post" style="display:inline;">
          <button type="submit" class="nav-logout-btn">Cerrar Sesi√≥n</button>
        </form>
      </li>
    </ul>
  </nav>
</header>

<main class="mis-compras-main-content">
  <h2>Mis Compras Realizadas</h2>

  <!-- Mensajes de error y √©xito -->
  <div th:if="${errorMessage}" class="error-message">
    <p th:text="${errorMessage}"></p>
  </div>
  
  <div th:if="${successMessage}" class="success-message">
    <p th:text="${successMessage}"></p>
  </div>

  <div th:if="${pedidos.isEmpty()}" class="empty-message">
    <p>A√∫n no has realizado ninguna compra.</p>
    <p><a th:href="@{/}" class="btn-link">Ver productos para empezar a comprar</a></p>
  </div>

  <div class="pedidos-list" th:unless="${pedidos.isEmpty()}">
    <div class="pedido-card" th:each="pedido : ${pedidos}">
      <div class="pedido-header">
        <h3>Pedido #<span th:text="${pedido.id}">123</span></h3>
        <span class="pedido-estado" 
              th:classappend="${pedido.estado == 'COMPLETADO' ? 'estado-completado' : 
                             (pedido.estado == 'PENDIENTE' ? 'estado-pendiente' : 
                             (pedido.estado == 'EN_PROCESO' ? 'estado-proceso' : 
                             (pedido.estado == 'CANCELADO' ? 'estado-cancelado' : '')))}"
              th:switch="${pedido.estado}">
          <span th:case="'PENDIENTE'" th:text="'Pendiente'">PENDIENTE</span>
          <span th:case="'EN_PROCESO'" th:text="'En Proceso'">EN_PROCESO</span>
          <span th:case="'COMPLETADO'" th:text="'Completado'">COMPLETADO</span>
          <span th:case="'CANCELADO'" th:text="'Cancelado'">CANCELADO</span>
          <span th:case="*" th:text="${pedido.estado}">DESCONOCIDO</span>
        </span>
      </div>
      <p>Fecha: <span th:text="${#temporals.format(pedido.fecha, 'dd/MM/yyyy')}"></span></p>
      <p>Total: S/ <span th:text="${#numbers.formatDecimal(pedido.total, 1, 2)}">0.00</span></p>
      <p>M√©todo de Pago: <span th:text="${pedido.metodoPago}"></span></p>

      <div class="pedido-detalles">
        <h4>Detalles del Pedido:</h4>
        <div class="productos-list">
          <div class="producto-item" th:each="detalle : ${pedido.detalles}">
            <div class="producto-info">
              <span class="producto-descripcion" 
                    th:text="${detalle.cantidad} + 'x ' + ${detalle.producto.nombre} + ' - S/ ' + ${#numbers.formatDecimal(detalle.precioUnitario, 1, 2)} + ' c/u'">
              </span>
              <span class="producto-subtotal">
                Subtotal: S/ <span th:text="${#numbers.formatDecimal(detalle.cantidad * detalle.precioUnitario, 1, 2)}">0.00</span>
              </span>
            </div>
            
            <!-- Botones de rese√±a solo para pedidos COMPLETADOS o CANCELADOS -->
            <div class="producto-actions" 
                 th:if="${pedido.estado == 'COMPLETADO' or pedido.estado == 'CANCELADO'}">
              
              <!-- Si ya rese√±√≥ el producto -->
              <div th:if="${productosResendados[detalle.producto.id]}" class="resena-status completed">
                <span class="resena-icon">‚úì</span>
                <span class="resena-text">Ya rese√±ado</span>
              </div>
              
              <!-- Si no ha rese√±ado el producto -->
              <div th:unless="${productosResendados[detalle.producto.id]}" class="resena-status pending">
                <a th:href="@{/resenas/crear(pedidoId=${pedido.id}, productoId=${detalle.producto.id})}" 
                   class="btn-resena">
                  <span class="resena-icon">‚òÖ</span>
                  <span class="resena-text">Escribir Rese√±a</span>
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Secci√≥n de Factura -->
      <div class="pedido-factura" th:if="${pedido.estado == 'COMPLETADO'}">
        <div class="factura-info">
          <h4>üìÑ Factura</h4>
          <p class="factura-status">
            <span class="factura-disponible">‚úì Factura disponible para descarga</span>
          </p>
        </div>
        <div class="factura-actions">
          <a th:href="@{/factura/vista/{id}(id=${pedido.id})}" 
             class="btn-factura btn-vista" 
             target="_blank"
             title="Ver factura en el navegador">
            <span class="factura-icon">üëÅÔ∏è</span>
            <span class="factura-text">Ver Factura</span>
          </a>
          <a th:href="@{/factura/descargar/{id}(id=${pedido.id})}" 
             class="btn-factura btn-descarga"
             title="Descargar factura PDF">
            <span class="factura-icon">‚¨áÔ∏è</span>
            <span class="factura-text">Descargar PDF</span>
          </a>
        </div>
      </div>
      
      <!-- Estado de factura para otros estados -->
      <div class="pedido-factura-info" th:unless="${pedido.estado == 'COMPLETADO'}">
        <div class="factura-info">
          <h4>üìÑ Factura</h4>
          <p class="factura-status" th:switch="${pedido.estado}">
            <span th:case="'PENDIENTE'" class="factura-pendiente">‚è≥ Factura disponible cuando el pedido sea completado</span>
            <span th:case="'EN_PROCESO'" class="factura-proceso">‚öôÔ∏è Factura disponible cuando el pedido sea completado</span>
            <span th:case="'CANCELADO'" class="factura-cancelado">‚ùå No disponible para pedidos cancelados</span>
            <span th:case="*" class="factura-desconocido">‚ùì Estado de factura desconocido</span>
          </p>
        </div>
      </div>
    </div>
  </div>
</main>

<footer>
  <p>&copy; 2025 Pasteler√≠a C√≥rdova. Todos los derechos reservados.</p>
</footer>

<script th:src="@{/js/main.js}"></script> <!-- Aseg√∫rate de que este script cargue y actualice el carrito si es necesario -->

</body>
</html>